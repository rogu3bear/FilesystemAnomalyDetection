{% extends "layout.html" %}

{% block title %}Logs{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-journal-text"></i> System Logs</h4>
                    <div>
                        <button id="refresh-logs" class="btn btn-light btn-sm" aria-label="Refresh logs">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <a href="/download-logs" class="btn btn-light btn-sm" aria-label="Download logs">
                            <i class="bi bi-download"></i> Download
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-group row">
                            <div class="col-md-3">
                                <label for="log-level-filter" class="form-label">Filter by Level</label>
                                <select id="log-level-filter" class="form-select">
                                    <option value="all">All Levels</option>
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="CRITICAL">CRITICAL</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="log-date-filter" class="form-label">Filter by Date</label>
                                <input type="date" id="log-date-filter" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="log-search" class="form-label">Search Logs</label>
                                <input type="text" id="log-search" class="form-control" placeholder="Search for text in logs...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="log-container">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Level</th>
                                        <th>Source</th>
                                        <th>Message</th>
                                    </tr>
                                </thead>
                                <tbody id="logs-content">
                                    {% if logs %}
                                        {% for log in logs %}
                                        <tr class="log-entry {{ log.level|lower }}">
                                            <td class="log-time">{{ log.timestamp }}</td>
                                            <td class="log-level">
                                                <span class="badge {% if log.level == 'DEBUG' %}bg-secondary{% elif log.level == 'INFO' %}bg-primary{% elif log.level == 'WARNING' %}bg-warning{% elif log.level == 'ERROR' %}bg-danger{% elif log.level == 'CRITICAL' %}bg-dark{% endif %}">
                                                    {{ log.level }}
                                                </span>
                                            </td>
                                            <td class="log-source">{{ log.source }}</td>
                                            <td class="log-message">{{ log.message }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No logs available</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-3">
                        <button id="load-more" class="btn btn-outline-primary" {% if not more_logs %}disabled{% endif %}>
                            <i class="bi bi-plus-circle"></i> Load More
                        </button>
                        <button id="clear-logs" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Clear Logs
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="clear-logs-modal" tabindex="-1" aria-labelledby="clearLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearLogsModalLabel">Confirm Clear Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to clear all logs? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="/clear-logs" method="post">
                    <button type="submit" class="btn btn-danger">Clear All Logs</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up refresh button
        document.getElementById('refresh-logs').addEventListener('click', function() {
            window.location.reload();
        });
        
        // Set up clear logs button
        document.getElementById('clear-logs').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('clear-logs-modal'));
            modal.show();
        });
        
        // Filter logs by level
        document.getElementById('log-level-filter').addEventListener('change', filterLogs);
        
        // Filter logs by date
        document.getElementById('log-date-filter').addEventListener('change', filterLogs);
        
        // Search logs
        document.getElementById('log-search').addEventListener('input', filterLogs);
        
        function filterLogs() {
            const levelFilter = document.getElementById('log-level-filter').value;
            const dateFilter = document.getElementById('log-date-filter').value;
            const searchText = document.getElementById('log-search').value.toLowerCase();
            
            const logEntries = document.querySelectorAll('.log-entry');
            
            logEntries.forEach(function(entry) {
                const level = entry.querySelector('.log-level').textContent.trim();
                const timestamp = entry.querySelector('.log-time').textContent.trim();
                const message = entry.querySelector('.log-message').textContent.toLowerCase();
                const source = entry.querySelector('.log-source').textContent.toLowerCase();
                
                let showByLevel = levelFilter === 'all' || level.includes(levelFilter);
                let showByDate = !dateFilter || timestamp.includes(dateFilter);
                let showBySearch = !searchText || 
                                  message.includes(searchText) || 
                                  source.includes(searchText) ||
                                  timestamp.includes(searchText);
                
                if (showByLevel && showByDate && showBySearch) {
                    entry.style.display = '';
                } else {
                    entry.style.display = 'none';
                }
            });
        }
        
        // Load more logs
        document.getElementById('load-more').addEventListener('click', function() {
            const lastTimestamp = document.querySelector('.log-entry:last-child .log-time').textContent;
            
            fetch(`/logs?before=${encodeURIComponent(lastTimestamp)}`)
                .then(response => response.text())
                .then(html => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    const newLogs = tempDiv.querySelectorAll('.log-entry');
                    const logsContent = document.getElementById('logs-content');
                    
                    newLogs.forEach(function(log) {
                        logsContent.appendChild(log.cloneNode(true));
                    });
                    
                    if (newLogs.length === 0) {
                        document.getElementById('load-more').disabled = true;
                    }
                    
                    filterLogs();
                })
                .catch(error => console.error('Error loading more logs:', error));
        });
    });
</script>
{% endblock %} 